name: M2 K&R check
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  static:
    name: M2 Coding Standard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          path: project

      - name: Create Standard Directory
        shell: bash
        run: mkdir standard

      - name: Set PHP Version
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.1
          tools: composer:v2
          coverage: none

      - name: Install Coding Standard
        shell: bash
        working-directory: standard
        run: |
          composer require "magento/magento-coding-standard"
          composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true

      - name: Register Coding Standard
        shell: bash
        working-directory: standard
        run: vendor/bin/phpcs --config-set installed_paths ${{ github.workspace }}/standard/vendor/magento/magento-coding-standard,${{ github.workspace }}/standard/vendor/phpcompatibility/php-compatibility

      - name: Get Changed Files
        shell: bash
        working-directory: project
        id: changed-files
        run: echo "files=$(git diff --name-only --diff-filter=ACMRT ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | xargs)" >> $GITHUB_OUTPUT
        if: github.event_name == 'pull_request'

      - name: Coding Standard Check
        shell: bash
        run: ../standard/vendor/bin/phpcs --standard=ruleset.xml ${{ github.event_name == 'pull_request' && steps.changed-files.outputs.files || 'app/code' }}
        working-directory: project
  phpstan:
    name: M2 PHPStan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          path: project

      - name: Create Standard Directory
        shell: bash
        run: mkdir standard

      - name: Set PHP Version
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.1
          extensions: mbstring, intl, soap, bcmath, gd, xml
          tools: composer:v2.2
          coverage: none

      - name: Set Magento Auth
        shell: bash
        run: composer config --global http-basic.repo.magento.com "${{ secrets.MAGENTO_PUBLIC_KEY }}" "${{ secrets.MAGENTO_PRIVATE_KEY }}"

      - name: Install PHPstan
        shell: bash
        working-directory: project
        run: composer install

      - name: Get Changed Files
        shell: bash
        working-directory: project
        id: changed-files
        run: echo "files=$(git diff --name-only --diff-filter=ACMRT ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | xargs)" >> $GITHUB_OUTPUT
        if: github.event_name == 'pull_request'

      - name: PHPstan Check
        shell: bash
        run: vendor/bin/phpstan analyse --configuration=phpstan.neon --error-format=github ${{ github.event_name == 'pull_request' && steps.changed-files.outputs.files || 'app/code' }}
        working-directory: project
